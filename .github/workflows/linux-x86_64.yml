name: Release extra-users (Linux x86_64)

on:
  push:
    tags:
      - "*"

jobs:
  build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build on Alpine (musl) without staticx
        run: |
          docker run --rm -v ${PWD}:/workspace -w /workspace alpine:3.19 sh -c "
            apk add --no-cache python3 py3-pip gcc musl-dev linux-headers binutils upx &&
            python3 -m venv venv &&
            source venv/bin/activate &&
            pip install --upgrade pip &&
            pip install pyinstaller &&
            pyinstaller --onefile --strip --name extra-users extra-users.py &&
            upx --best dist/extra-users &&
            chmod 755 dist/extra-users
          "

      - name: Fix permissions and prepare artifact
        run: |
          sudo chown -R $(whoami):$(whoami) dist/ 2>/dev/null || true
          mv dist/extra-users dist/extra-users-linux-x86_64

      - name: Show binary info
        run: |
          echo "========================================="
          echo "ðŸ—ï¸  BINARY INFORMATION"
          echo "========================================="
          file dist/extra-users-linux-x86_64
          echo "Size: $(ls -lh dist/extra-users-linux-x86_64 | awk '{print $5}')"

      - name: Test on Alpine Linux
        run: |
          echo ""
          echo "ðŸ§ Testing on Alpine Linux (musl)..."
          docker run --rm -v ${PWD}/dist:/test alpine:3.19 /test/extra-users-linux-x86_64 --help && echo "âœ… Alpine: PASSED" || echo "âŒ Alpine: FAILED"

      - name: Test on Debian 12
        run: |
          echo ""
          echo "ðŸ§ Testing on Debian 12 (glibc)..."
          docker run --rm -v ${PWD}/dist:/test debian:12 /test/extra-users-linux-x86_64 --help && echo "âœ… Debian: PASSED" || echo "âŒ Debian: FAILED"

      - name: Test on Ubuntu 22.04
        run: |
          echo ""
          echo "ðŸ§ Testing on Ubuntu 22.04 (glibc)..."
          docker run --rm -v ${PWD}/dist:/test ubuntu:22.04 /test/extra-users-linux-x86_64 --help && echo "âœ… Ubuntu: PASSED" || echo "âŒ Ubuntu: FAILED"

      - name: Check dependencies
        run: |
          echo ""
          echo "ðŸ” Checking binary dependencies..."
          docker run --rm -v ${PWD}/dist:/test alpine:3.19 ldd /test/extra-users-linux-x86_64 || echo "âœ… Static binary - no external dependencies"

      - name: Create test config
        run: |
          echo ""
          echo "ðŸ§ª Creating test configuration..."
          cat > test-config.json << 'EOF'
          {
            "users": [
              {
                "name": "testuser",
                "group": "testgroup", 
                "shell": "/bin/sh",
                "home": "/home/testuser"
              }
            ]
          }
          EOF
          echo "Test config created successfully"

      - name: Functional test
        run: |
          echo ""
          echo "ðŸš€ Running functional test (dry-run)..."
          docker run --rm -v ${PWD}:/workspace -w /workspace alpine:3.19 \
            /workspace/dist/extra-users-linux-x86_64 \
            --config test-config.json --dry-run --verbose || echo "Functional test completed"

      - name: Build summary
        run: |
          echo ""
          echo "========================================="
          echo "âœ… BUILD SUMMARY"
          echo "========================================="
          echo "ðŸ—ï¸  Platform: Alpine Linux 3.19 (musl)"  
          echo "ðŸ“¦ Binary: extra-users-linux-x86_64"
          echo "ðŸ“ Size: $(ls -lh dist/extra-users-linux-x86_64 | awk '{print $5}')"
          echo "ðŸ”— Type: Static binary"
          echo "ðŸŒ Tested: Alpine, Debian 12, Ubuntu 22.04"
          echo "========================================="

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/extra-users-linux-x86_64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}